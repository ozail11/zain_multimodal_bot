<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ZainBot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(20px);}
      100% { opacity: 1; transform: translateY(0);}
    }
    .animate-fadeInUp {
      animation: fadeInUp 0.4s ease-out;
    }
    body { font-family: 'Cairo', sans-serif; }
  </style>
</head>
<body class="bg-gray-100 font-[Cairo]">

  <!-- Ø²Ø± Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… -->
  <img
    id="toggleChat"
    src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png"
    alt="Ø¨ÙˆØª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©"
    class="fixed bottom-6 right-6 w-14 h-14 rounded-full shadow-lg cursor-pointer z-50 hover:brightness-90 transition"
  />

  <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù… -->
  <div id="chatBox" class="hidden fixed bottom-20 right-6 w-[350px] h-[550px] bg-white rounded-xl shadow-lg p-4 z-40 flex flex-col">
    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <div class="flex items-center justify-between border-b pb-2 mb-2">
      <div class="flex items-center gap-2">
        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" alt="Bot Icon" class="w-8 h-8 rounded-full"/>
        <h2 class="font-bold text-blue-600">zain moltimodal bot</h2>
      </div>
      <button id="closeChat" class="text-gray-500 hover:text-red-600"><i class="fas fa-times"></i></button>
    </div>

    <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div id="messages" class="flex-1 overflow-y-auto space-y-2 mb-3 text-sm text-gray-800"></div>

    <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø§ÙŠÙƒ -->
    <video id="cameraStream" class="hidden"></video>
    <canvas id="snapshotCanvas" class="hidden"></canvas>

    <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
    <div class="flex items-center gap-2">
      <input id="input" type="text" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." class="flex-1 p-2 border rounded focus:outline-none text-sm"/>
      <label for="mediaInput" class="cursor-pointer text-lg text-gray-500"><i class="fas fa-paperclip"></i></label>
      <button id="send" class="text-blue-600 text-lg"><i class="fas fa-paper-plane"></i></button>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµÙˆØª ÙˆØ§Ù„ØµÙˆØ±Ø© -->
    <div class="flex justify-between mt-2 text-gray-600">
      <button id="camera"><i class="fas fa-camera text-lg"></i></button>
      <button id="mic"><i class="fas fa-microphone text-lg"></i></button>
    </div>

    <!-- Ù…Ø±ÙÙ‚Ø§Øª -->
    <input type="file" id="mediaInput" class="hidden" multiple accept="image/*,video/*,application/pdf" />
  </div>

  <script>
    // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª (Ø£Ù†Øª Ø­Ø± Ø¨ØªØºÙŠÙŠØ±Ù‡Ø§)
    const botIcon = "https://cdn-icons-png.flaticon.com/512/4712/4712109.png";
    const userIcon = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const toggleBtn = document.getElementById('toggleChat');
    const closeBtn = document.getElementById('closeChat');
    const chatBox = document.getElementById('chatBox');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const messages = document.getElementById('messages');
    const mic = document.getElementById('mic');
    const camera = document.getElementById('camera');
    const video = document.getElementById('cameraStream');
    const canvas = document.getElementById('snapshotCanvas');
    const mediaInput = document.getElementById('mediaInput');

    // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨ÙˆØª
    toggleBtn.onclick = () => {
      if (chatBox.classList.contains('hidden')) {
        chatBox.classList.remove('hidden');
        chatBox.classList.add('animate-fadeInUp');
        setTimeout(() => { chatBox.classList.remove('animate-fadeInUp'); }, 400);
      } else {
        chatBox.classList.add('hidden');
      }
    };
    closeBtn.onclick = () => chatBox.classList.add('hidden');

    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø³Ù„
    // align: 'right' = Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙŠØ³Ø§Ø±), 'left' = Ø§Ù„Ø¨ÙˆØª (Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙŠÙ…ÙŠÙ†)
    function addMessage(content, type = 'text', align = 'right') {
      const wrapper = document.createElement('div');
      wrapper.style.direction = "rtl";
      wrapper.className = "flex items-end gap-2 mb-1 " + (align === 'right' ? "justify-end" : "justify-start");

      if (align === 'right') {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙŠÙ…ÙŠÙ†ØŒ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙŠØ³Ø§Ø± (left)
        const msg = document.createElement('div');
        msg.className = "px-2 py-1 rounded max-w-[70%] bg-blue-100 ml-2";
        msg.style.textAlign = "left";
        if (type === 'text') {
          msg.textContent = content;
        } else if (type === 'image') {
          const img = document.createElement('img');
          img.src = content;
          img.className = "w-full rounded";
          msg.appendChild(img);
        } else if (type === 'audio') {
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = content;
          msg.appendChild(audio);
        } else if (type === 'file') {
          const link = document.createElement('a');
          link.href = content.url;
          link.textContent = `ðŸ“Ž ${content.name}`;
          link.target = '_blank';
          msg.appendChild(link);
        }
        wrapper.appendChild(msg);

        const icon = document.createElement('img');
        icon.src = userIcon;
        icon.className = "w-8 h-8 rounded-full border";
        wrapper.appendChild(icon);

      } else {
        // Ø§Ù„Ø¨ÙˆØª: Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙŠÙ…ÙŠÙ† (right)ØŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙŠØ³Ø§Ø±
        const icon = document.createElement('img');
        icon.src = botIcon;
        icon.className = "w-8 h-8 rounded-full border";
        wrapper.appendChild(icon);

        const msg = document.createElement('div');
        msg.className = "px-2 py-1 rounded max-w-[70%] bg-gray-100 mr-2";
        msg.style.textAlign = "left";
        if (type === 'text') {
          msg.textContent = content;
        } else if (type === 'image') {
          const img = document.createElement('img');
          img.src = content;
          img.className = "w-full rounded";
          msg.appendChild(img);
        } else if (type === 'audio') {
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = content;
          msg.appendChild(audio);
        } else if (type === 'file') {
          const link = document.createElement('a');
          link.href = content.url;
          link.textContent = `ðŸ“Ž ${content.name}`;
          link.target = '_blank';
          msg.appendChild(link);
        }
        wrapper.appendChild(msg);
      }

      messages.appendChild(wrapper);
      messages.scrollTop = messages.scrollHeight;
    }

    // Ø·Ù„Ø¨ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¨ÙˆØª (Ø¨Ø§Ùƒ-Ø¥Ù†Ø¯)
    async function fetchBotReply(message) {
      try {
        const res = await fetch('/api/chat/', {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await res.json();
        return data.result || data.reply || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø¯ Ù…Ù† Ø§Ù„Ø¨ÙˆØª.";
      } catch {
        return "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….";
      }
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©
    send.onclick = async () => {
      if (input.value.trim()) {
        const userMsg = input.value;
        addMessage(userMsg, 'text', 'right'); // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        input.value = '';
        addMessage("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...", "text", "left"); // Ù…Ø¤Ù‚Øª
        const botReply = await fetchBotReply(userMsg);
        messages.lastChild.remove(); // Ø¥Ø²Ø§Ù„Ø© Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±
        addMessage(botReply, "text", "left"); // Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
      }
    };
    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') send.click(); });

    // ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª
    let mediaRecorder;
    let chunks = [];
    mic.addEventListener('mousedown', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          addMessage(url, 'audio', 'right');
          chunks = [];
        };
        mediaRecorder.start();
      } catch (err) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + err.message);
      }
    });
    mic.addEventListener('mouseup', () => {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
    });

    // Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©
    camera.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.play();
        await new Promise(resolve => video.onloadedmetadata = resolve);
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/png');
        addMessage(imageData, 'image', 'right');
        stream.getTracks().forEach(track => track.stop());
      } catch (err) {
        alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err.message);
      }
    };

    // Ù…Ø±ÙÙ‚Ø§Øª Ù…Ù„ÙØ§Øª Ø£Ùˆ ØµÙˆØ±
    mediaInput.addEventListener('change', () => {
      [...mediaInput.files].forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = () => addMessage(reader.result, 'image', 'right');
          reader.readAsDataURL(file);
        } else {
          const url = URL.createObjectURL(file);
          addMessage({url, name: file.name}, 'file', 'right');
        }
      });
    });
  </script>
</body>
</html>